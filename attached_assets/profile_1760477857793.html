<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Profile ‚Ä¢ V√∏id P√¶ragon</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" />
  <style>
    body {
      background: #000;
      color: #ddd;
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
    }

    header {
      text-align: center;
      margin-top: 2rem;
    }

    #profile {
      background: rgba(20, 20, 20, 0.95);
      padding: 2rem;
      border-radius: 10px;
      border: 1px solid #7a00ff;
      box-shadow: 0 0 18px rgba(122, 0, 255, 0.25);
      max-width: 700px;
      margin: 3rem auto;
    }

    #profilePic {
      display: block;
      width: 140px;
      height: 140px;
      border-radius: 50%;
      border: 3px solid #7a00ff;
      box-shadow: 0 0 12px rgba(122, 0, 255, 0.3);
      object-fit: cover;
      margin: 0 auto 1rem;
    }

    h2 {
      color: #7a00ff;
      text-align: center;
      margin-top: 1.5rem;
    }

    #usernameDisplay {
      font-weight: bold;
      font-size: 1.3rem;
      color: #fff;
    }

    label {
      display: block;
      margin-top: 1rem;
      color: #bbb;
    }

    input, textarea {
      width: 100%;
      background: #111;
      color: #eee;
      border: 1px solid #333;
      padding: 0.6rem;
      border-radius: 6px;
    }

    button {
      background: #7a00ff;
      border: none;
      padding: 0.6rem 1.2rem;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 1.5rem;
    }

    button:hover { opacity: 0.85; }

    .novel-card {
      background: #111;
      border: 1px solid #222;
      padding: 0.8rem;
      border-radius: 6px;
      margin-top: 1rem;
    }

    .novel-card h3 { color: #9b59b6; }

    /* === Floating Menu === */
    #menuToggle {
      position: fixed;
      top: 1rem;
      left: 1rem;
      background: #7a00ff;
      color: white;
      border: none;
      padding: 0.5rem 0.7rem;
      border-radius: 6px;
      cursor: pointer;
      z-index: 1000;
    }

    #sideMenu {
      position: fixed;
      top: 0;
      left: -220px;
      height: 100%;
      width: 200px;
      background: rgba(15, 15, 15, 0.97);
      border-right: 2px solid #7a00ff;
      padding-top: 4rem;
      display: flex;
      flex-direction: column;
      transition: left 0.3s ease-in-out;
      z-index: 999;
    }

    #sideMenu.active { left: 0; }

    #sideMenu a {
      color: #ddd;
      text-decoration: none;
      padding: 0.8rem 1rem;
      display: block;
      border-bottom: 1px solid #222;
      transition: background 0.2s;
    }

    #sideMenu a:hover { background: #7a00ff33; }

    #logout { margin-top: auto; border-top: 1px solid #333; }

    /* Centered button layout */
    .center-btns {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
  </style>
</head>
<body>
  <!-- Floating Menu Button -->
  <button id="menuToggle">‚ò∞</button>

  <!-- Side Menu -->
  <nav id="sideMenu">
    <a href="homepage.html">üè† Home</a>
    <a href="homefeed.html">üìÉ Feed</a>
    <a href="Novels.html">üìö Novels</a>
    <a href="coding.html">üíª Coding</a>
    <a href="community.html">üåç Community</a>
    <a href="notifications.html" class="active">üîî Notifications</a>
    <a href="profile.html" class="active">üë§ Profile</a>
    <a href="support.html">üõ† Support</a>
    <a id="logout" href="logout.html">üö™ Logout</a>
  </nav>

  <header>
    <h1><span id="usernameDisplay">Guest</span></h1>
    <div class="center-btns">
      <button id="messageBtn">üí¨ Message</button>
    </div>
    <p>View and manage your Void Paragon profile.</p>
  </header>

  <section id="profile">
    <img id="profilePic" src="https://via.placeholder.com/150/000000/FFFFFF?text=No+Image" alt="Profile Picture">

    <label for="imgLink">Profile Image Link</label>
    <input type="url" id="imgLink" placeholder="Paste your image URL here">

    <label for="bio">Bio</label>
    <textarea id="bio" placeholder="Write something about yourself..."></textarea>

    <label for="link">Website or Social Link</label>
    <input type="url" id="link" placeholder="https://example.com" />

    <button id="saveProfile">Save Profile</button>

    <h2>Your Works</h2>
    <div id="yourNovels">Loading...</div>

    <h2>Currently Reading</h2>
    <div id="readingList">Loading...</div>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD5SkjADPqjkjEsmV_tUAk-KWNRFK59t_s",
      authDomain: "void-paragon-site.firebaseapp.com",
      databaseURL: "https://void-paragon-site-default-rtdb.firebaseio.com",
      projectId: "void-paragon-site",
      storageBucket: "void-paragon-site.firebasestorage.app",
      messagingSenderId: "109588109735",
      appId: "1:109588109735:web:611c31b37a4a1de5113e82"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const username = localStorage.getItem("vp_username") || "guest_A004";
    document.getElementById("usernameDisplay").textContent = username;

    const bioEl = document.getElementById("bio");
    const linkEl = document.getElementById("link");
    const imgEl = document.getElementById("imgLink");
    const preview = document.getElementById("profilePic");
    const saveBtn = document.getElementById("saveProfile");

    const userRef = ref(db, "users/" + username);

    // Live preview for image
    imgEl.addEventListener("input", () => {
      const url = imgEl.value.trim();
      if (url) preview.src = url;
    });

    // Load profile info
    get(userRef).then(snapshot => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        bioEl.value = data.bio || "";
        linkEl.value = data.link || "";
        imgEl.value = data.image || "";
        if (data.image) preview.src = data.image;
      }
    });

    // Save profile
    saveBtn.addEventListener("click", () => {
      set(userRef, {
        bio: bioEl.value.trim(),
        link: linkEl.value.trim(),
        image: imgEl.value.trim()
      });
      alert("Profile updated successfully.");
    });

    // Load novels
    const novelsContainer = document.getElementById("yourNovels");
    onValue(ref(db, "novels"), snapshot => {
      novelsContainer.innerHTML = "";
      if (snapshot.exists()) {
        snapshot.forEach(childSnap => {
          const novel = childSnap.val();
          if (novel.author === username) {
            const card = document.createElement("div");
            card.className = "novel-card";
            card.innerHTML = `
              <h3>${novel.title}</h3>
              <p>${novel.synopsis || "No synopsis yet."}</p>
              <button onclick="window.location.href='Novels.html?id=${childSnap.key}'">Edit</button>
            `;
            novelsContainer.appendChild(card);
          }
        });
      } else novelsContainer.textContent = "No novels yet.";
    });

    // Load reading list
    const readingContainer = document.getElementById("readingList");
    onValue(ref(db, "reading/" + username), snapshot => {
      readingContainer.innerHTML = "";
      if (snapshot.exists()) {
        snapshot.forEach(childSnap => {
          const data = childSnap.val();
          const div = document.createElement("div");
          div.className = "novel-card";
          div.innerHTML = `<h3>${data.title}</h3><p>Progress: ${data.chapter}</p>`;
          readingContainer.appendChild(div);
        });
      } else readingContainer.textContent = "You aren‚Äôt reading anything yet.";
    });

    // === Message button: creates private chat thread ===
    const messageBtn = document.getElementById("messageBtn");
    messageBtn.addEventListener("click", () => {
      const currentUser = localStorage.getItem("vp_username") || "guest_A004";
      if (currentUser === username) return alert("You can't message yourself.");
      
      const chatID = [currentUser, username].sort().join("_");
      push(ref(db, "private_chats/" + chatID), {
        sender: currentUser,
        message: "(Started a chat)",
        time: new Date().toISOString()
      });
      localStorage.setItem("currentChat", chatID);
      alert("Chat created successfully! Redirecting to messages...");
      window.location.href = "community.html"; // will open their DM area
    });

    // Menu toggle
    const menuBtn = document.getElementById("menuToggle");
    const menu = document.getElementById("sideMenu");
    menuBtn.addEventListener("click", () => {
      menu.classList.toggle("active");
    });
  </script>
</body>
</html>